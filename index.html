<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coloranly Palette Extractor</title>
    <style>
        :root {
            --bg-color: #f0f0f0;
            --frame-color: #333333;
            --text-color: #333333;
            --button-bg: #e0e0e0;
            --button-text: #333333;
            --settings-bg: #ffffff;
            --settings-outline: #cccccc;
            --slider-track: #dddddd;
            --slider-thumb: #666666;
            --checkbox-color: #666666;
            --frame-radius: 5px;
            --button-radius: 30px;
            --settings-radius: 3px;
            --font-family: 'Monospace', monospace;
            --font-size: 14px;
            --text-align: center;
            --in-frame-ui-scale: 1;
            --number-input-bg: #ffffff;
            --number-input-outline-color: #cccccc;
            --number-input-outline-radius: 30px;
            --frame-custom-size: 400px;
            --frame-custom-min-size: 300px;

            --table-header-bg: #f5f5f5;
            --table-row-bg-odd: #ffffff;
            --table-row-bg-even: #f9f9f9;
            --table-border-color: #e0e0e0;
            --color-outline-color: #0000ff;
            --copy-btn-hover-bg: rgba(0,0,0,0.05);
            --skin-tone-result-text-color: #000000;
            --delete-button-bg: #ff4d4d;
            --delete-button-text: white;
            --delete-button-hover-bg: #cc0000;
            --suggested-palette-outline: #888888;
        }

        body.dark-theme {
            --bg-color: #000000;
            --frame-color: #888888;
            --text-color: #e0e0e0;
            --button-bg: #121211;
            --button-text: #e0e0e0;
            --settings-bg: #121211;
            --settings-outline: #444444;
            --slider-track: #555555;
            --slider-thumb: #aaaaaa;
            --checkbox-color: #aaaaaa;
            --table-header-bg: #3a3a3a;
            --table-row-bg-odd: #2a2a2a;
            --table-row-bg-even: #303030;
            --table-border-color: #444444;
            --color-outline-color: #9999ff;
            --copy-btn-hover-bg: rgba(255,255,255,0.1);
            --skin-tone-result-text-color: #e0e0e0;
            --number-input-bg: #3a3a3a;
            --number-input-outline-color: #555555;
            --delete-button-bg: #993333;
            --delete-button-hover-bg: #cc0000;
            --suggested-palette-outline: #666666;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            font-size: var(--font-size);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }

        .header #settings-button {
            margin-left: auto;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
        }

        .left-panel-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90vmin;
            flex-shrink: 0;
        }

        .frame {
            border: 1.6px solid var(--frame-color);
            border-radius: var(--frame-radius);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            resize: both;
            aspect-ratio: 1 / 1;
            width: var(--frame-custom-size, 90vmin);
            height: var(--frame-custom-size, 90vmin);
            min-width: var(--frame-custom-min-size);
            min-height: var(--frame-custom-min-size);
            max-width: 100%;
            max-height: 90vh;
            overflow: hidden;
            cursor: default;
        }

        .frame.eyedropper-active {
            cursor: none;
        }

        .frame.fullscreen-active {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            resize: none !important;
            z-index: 9999 !important;
            background-color: var(--bg-color) !important;
        }

        #image-display {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            user-select: none;
        }

        #image-display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .action-buttons,
        .fullscreen-bottom-left-controls {
            position: absolute;
            z-index: 10001;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 3px;
        }

        .action-buttons {
            top: 5px;
            left: 5px;
            display: flex;
            gap: 3px;
            transform: scale(var(--in-frame-ui-scale));
            transform-origin: top left;
            background-color: transparent;
        }

        .fullscreen-bottom-left-controls {
            bottom: 5px;
            left: 5px;
            display: none;
            transform: scale(var(--in-frame-ui-scale));
            transform-origin: bottom left;
        }

        .frame.ui-hidden .action-buttons,
        .frame.ui-hidden .fullscreen-bottom-left-controls {
            opacity: 0;
            pointer-events: none;
        }

        .frame.ui-hidden .fullscreen-bottom-left-controls #hide-ui-button {
            opacity: 1;
            pointer-events: auto;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: rgba(0, 0, 0, 0.5);
        }

        .frame.ui-hidden .fullscreen-bottom-left-controls:hover #hide-ui-button {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid black;
            color: black;
        }

        .frame.hidden {
            display: none;
        }

        .controls {
            display: flex;
            justify-content: flex-start;
            width: 100%;
            margin-top: 10px;
            flex-wrap: wrap;
            gap: 10px;
            transition: all 0.3s ease-in-out;
        }

        .controls.minimized {
            max-height: 0;
            overflow: hidden;
            padding: 0 10px;
            margin-top: 0;
            opacity: 0;
            pointer-events: none;
        }

        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--frame-color);
            padding: 8px 15px;
            cursor: pointer;
            font-family: var(--font-family);
            border-radius: var(--button-radius);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        button:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .action-buttons button,
        .fullscreen-bottom-left-controls button {
            font-size: 11px;
            padding: 3px 9px;
            border-radius: 20px;
        }

        #settings-panel {
            background-color: var(--settings-bg);
            border: 1px solid var(--settings-outline);
            border-radius: var(--settings-radius);
            padding: 15px;
            z-index: 10002;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
            position: fixed;
            top: 50px;
            right: 8px;
            width: 300px;
            max-width: 90vw;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #settings-panel .settings-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--settings-outline);
        }
        #settings-panel .settings-panel-header h3 {
            margin: 0;
        }
        #settings-panel .settings-panel-header .header-buttons {
            display: flex;
            gap: 5px;
        }
        #settings-panel .settings-panel-header .header-buttons button {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
            margin: 0;
        }
        
        #palette-analysis-panel {
            background-color: var(--settings-bg);
            border: 1px solid var(--settings-outline);
            border-radius: var(--settings-radius);
            padding: 0;
            z-index: 10002;
            max-height: 80vh;
            overflow: hidden;
            box-sizing: border-box;
            position: relative;
            margin-top: 20px;
            max-width: 90vw;
            display: flex;
            flex-direction: column;
            --header-height: 60px;
            user-select: none;
            font-size: var(--font-size);
        }

        #settings-panel input, #settings-panel select,
        #palette-analysis-panel input, #palette-analysis-panel select {
            user-select: text;
            font-family: var(--font-family);
            font-size: var(--font-size);
        }

        .settings-header {
            background-color: var(--settings-bg);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 1px solid var(--settings-outline);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--header-height);
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        .settings-header h3 {
            margin: 0;
        }

        .settings-content-scrollable {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: calc(80vh - var(--header-height));
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        .drag-handle {
            position: static;
            order: 2;
            margin-left: 10px;
            cursor: move;
            font-size: 20px;
            color: var(--settings-outline);
            z-index: 10;
            display: none;
        }

        .drag-handle:hover {
            color: var(--frame-color);
        }

        .setting-group {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--settings-outline);
        }
        .setting-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .setting-group h4, .setting-group h5 {
            margin-top: 0;
            margin-bottom: 10px;
            font-family: var(--font-family);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-family: var(--font-family);
        }

        input[type="color"],
        input[type="text"],
        select {
            background-color: var(--number-input-bg);
            border: 1px solid var(--number-input-outline-color);
            color: var(--text-color);
            padding: 1px;
            margin-bottom: 5px;
            width: calc(100% - 12px);
            border-radius: var(--number-input-outline-radius);
            font-family: var(--font-family);
        }

        input[type="number"] {
            background-color: var(--number-input-bg);
            color: var(--text-color);
            border: 1px solid var(--number-input-outline-color);
            border-radius: var(--number-input-outline-radius);
            padding: 3px 5px;
            box-sizing: border-box;
            width: calc(100% - 12px);
            margin-bottom: 5px;
            font-family: var(--font-family);
        }

        .slider-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .slider-input-group label {
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .slider-input-group input[type="range"] {
            flex-grow: 1;
            width: auto;
            margin-bottom: 0;
        }

        .slider-input-group input[type="number"] {
            width: 60px;
            margin-bottom: 0;
            text-align: center;
            padding: 3px;
        }

        input[type="range"] {
            width: 40%;
            -webkit-appearance: none;
            height: 3px;
            background: var(--slider-track);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--slider-thumb);
            cursor: pointer;
        }

        input[type="checkbox"] {
            accent-color: var(--checkbox-color);
        }

        #hide-frame-ui-button,
        #swap-panels-button,
        #theme-toggle-button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--frame-color);
            padding: 6px 15px;
            cursor: pointer;
            font-family: var(--font-family);
            border-radius: var(--button-radius);
        }

        #swap-panels-button {
            display: none;
        }

        .main-container.side-by-side-layout {
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            gap: 20px;
            position: relative;
            padding: 20px;
        }

        .main-container.side-by-side-layout .left-panel-wrapper {
            flex: 1;
            min-width: 350px;
            max-width: 50vw;
            align-items: flex-start;
        }

        .main-container.side-by-side-layout .frame {
            width: var(--frame-custom-size, 70vh);
            height: var(--frame-custom-size, 70vh);
            min-height: var(--frame-custom-min-size, 400px);
            max-height: 80vh;
            min-width: var(--frame-custom-min-size, 300px);
            max-width: 100%;
        }

        .main-container.side-by-side-layout .controls {
            width: 100%;
            justify-content: flex-start;
        }

        .main-container.side-by-side-layout #palette-analysis-panel {
            flex: 1;
            min-width: 300px;
            max-width: 40vw;
            height: auto;
            max-height: 90vh;
            margin-top: 0;
            resize: both;
            transform: translate3d(0, 0, 0);
        }

        .main-container.side-by-side-layout #palette-analysis-panel .drag-handle {
            display: block !important;
        }

        .main-container.swapped .left-panel-wrapper {
            order: 2;
        }
        .main-container.swapped #palette-analysis-panel {
            order: 1;
        }

        .main-container.side-by-side-layout #swap-panels-button {
            display: inline-block;
        }

        #color-palette-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size);
            table-layout: fixed;
            margin-top: 15px;
            font-family: var(--font-family);
        }

        #color-palette-table th,
        #color-palette-table td {
            border: 1px solid var(--table-border-color);
            padding: 6px 4px;
            text-align: left;
            word-break: break-all;
        }

        #color-palette-table th {
            background-color: var(--table-header-bg);
            font-weight: bold;
            text-align: center;
        }

        #color-palette-table tbody tr:nth-child(odd) {
            background-color: var(--table-row-bg-odd);
        }

        #color-palette-table tbody tr:nth-child(even) {
            background-color: var(--table-row-bg-even);
        }

        #color-palette-table th:first-child,
        #color-palette-table td:first-child {
            width: 50px;
        }

        #color-palette-table th:nth-child(2),
        #color-palette-table td:nth-child(2) {
            width: calc(100% - 50px - 40px);
        }

        .color-sample-cell {
            padding: 0;
            text-align: center;
            vertical-align: middle;
        }

        .color-sample {
            width: 100%;
            height: 25px;
            border: 1px solid var(--frame-color);
            display: inline-block;
            vertical-align: middle;
            border-radius: 2px;
            box-sizing: border-box;
        }

        .color-code-cell .color-value {
            flex-grow: 1;
            cursor: pointer;
            padding-right: 5px;
        }
        .color-code-cell .color-value:hover {
            background-color: var(--copy-btn-hover-bg);
            border-radius: 3px;
        }

        .delete-btn {
            background-color: var(--delete-button-bg);
            color: var(--delete-button-text);
            border: none;
            padding: 3px 6px;
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
            width: 100%;
            box-sizing: border-box;
        }
        .delete-btn:hover {
            background-color: var(--delete-button-hover-bg);
        }


        .color-location-indicator {
            position: absolute;
            width: 1em;
            height: 1em;
            color: var(--color-outline-color);
            font-size: 1.5em;
            line-height: 1;
            text-align: center;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }

        #eyedropper-crosshair {
            position: fixed;
            width: 12px;
            height: 12px;
            border: 1px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 1px black;
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        #skin-tone-analysis-section {
            margin-top: 5px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--settings-outline);
        }
        #skin-tone-analysis-section h4 {
            margin-bottom: 5px;
        }
        #skin-tone-analysis-section p {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
            font-family: var(--font-family);
        }
        #pick-skin-tone-button {
            width: auto;
            padding: 6px 12px;
            margin-bottom: 10px;
        }
        #skin-tone-result {
            margin-top: 15px;
            border: 1px solid var(--settings-outline);
            border-radius: 5px;
            padding: 10px;
            background-color: var(--table-row-bg-even);
            font-weight: normal;
            color: var(--skin-tone-result-text-color);
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.6;
            font-family: var(--font-family);
        }
        #skin-tone-result strong, #season-analysis-result strong {
            display: block;
            margin-top: 8px;
            margin-bottom: 3px;
            font-size: 14px;
            color: var(--frame-color);
        }
        #skin-tone-result strong:first-child, #season-analysis-result strong:first-child {
            margin-top: 0;
        }

        #magnifier {
            position: fixed;
            width: 100px;
            height: 100px;
            border: 2px solid var(--frame-color);
            border-radius: 5px;
            overflow: hidden;
            z-index: 10003;
            background-color: var(--bg-color);
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: none;
            transform: translate(-50%, calc(-100% - 50px));
            font-family: var(--font-family);
        }

        #magnifier-canvas {
            display: block;
            width: 100%;
            height: calc(100% - 30px);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        #magnifier-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12;
            text-align: center;
            padding: 2px 0;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 30px;
        }
        #magnifier-info .color-display {
            width: 18px;
            height: 18px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 2px;
            flex-shrink: 0;
        }

        #magnifier-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: red;
            pointer-events: none;
            text-shadow: 0 0 3px black;
            font-weight: bold;
            transform: translate(-50%, -125%);
        }

        #copy-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .suggested-palettes {
            margin-top: 15px;
            border-top: 1px dashed var(--settings-outline);
            padding-top: 10px;
        }

        .suggested-palettes h5 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .color-palette-row {
            display: flex;
            margin-bottom: 8px;
            gap: 5px;
            flex-wrap: wrap;
        }

        .palette-color-swatch {
            width: 30px;
            height: 30px;
            border: 1px solid var(--suggested-palette-outline);
            cursor: pointer;
            position: relative;
            box-sizing: border-box;
            border-radius: 3px;
        }

        .palette-color-swatch:hover::after {
            content: attr(data-hex);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
            font-size: 10px;
            margin-bottom: 5px;
        }

        @media (max-width: 767px), (max-width: 991px) and (orientation: portrait) {
            .main-container {
                padding: 10px;
                flex-wrap: wrap;
                align-items: flex-start;
            }

            .frame {
                height: var(--frame-custom-size, 70vmin);
                width: var(--frame-custom-size, 70vmin);
            }
            .controls {
                justify-content: flex-start;
            }

            #settings-panel {
                width: 95vmin;
                max-width: 500px;
                max-height: 80vh;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin-top: 0;
                resize: none;
                box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            }

            #palette-analysis-panel {
                width: 95vmin;
                max-width: 500px;
                max-height: 80vh;
                position: static;
                margin-top: 20px;
                resize: none;
                transform: none;
            }

            #palette-analysis-panel .drag-handle {
                display: none !important;
            }

            .main-container.side-by-side-layout {
                flex-direction: column;
                gap: 15px;
                padding: 10px;
                align-items: center;
                justify-content: flex-start;
            }

            .main-container.side-by-side-layout .left-panel-wrapper,
            .main-container.side-by-side-layout #palette-analysis-panel {
                width: 95vw;
                max-width: 500px;
                min-width: unset;
                flex: unset;
            }

            .main-container.side-by-side-layout #palette-analysis-panel {
                resize: both;
            }

            .main-container.side-by-side-layout #palette-analysis-panel .drag-handle {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="layout-button">Layout</button>
        <button id="settings-button">Settings</button>
    </div>

    <div class="main-container">
        <div class="left-panel-wrapper">
            <div class="frame">
                <div class="action-buttons">
                	<button id="theme-toggle-button">Light</button>
                    <button id="fullscreen-button"> ⛶ </button>
                </div>
                <div class="fullscreen-bottom-left-controls" style="display: none;">
                    <button id="hide-ui-button">Hide</button>
                </div>
                <div id="image-display">
                    <img id="uploaded-image" src="" alt="Uploaded Image" style="display:none;">
                    <p id="placeholder-text">By Tsu.</p>
                </div>
                <div id="eyedropper-crosshair"></div>
            </div>
            <div class="controls">
                <button id="upload-button">Upload Image</button>
                <button id="clear-button">Clear</button>
                <button id="analyze-button">Analyze Colors</button>
                <button id="export-button">Export Results</button>
                <button id="palette-settings-button">Palette</button>
                <button id="hide-frame-ui-button">⦸</button>
                <button id="swap-panels-button">:D</button>
            </div>
        </div>
        <div id="palette-analysis-panel" style="display: none;">
            <div class="settings-header">
                <div id="drag-handle" class="drag-handle">|</div>
                <h3>Info </h3>
            </div>
			  <div class="settings-content-scrollable">


           <p>More Analysis Options Below</p>
                <div class="setting-group">
                    <h4>Extracted Color Palette</h4>
                    <button id="pick-color-button">Pick Color</button>
                    <table id="color-palette-table">
                        <thead>
                            <tr>
                                <th style="width:50px;">Color</th>
                                <th>Hex</th>
                                <th style="width: 40px;">DEL</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <p style="font-size:12px; opacity:0.8; margin-top:10px;">Click on a color code to copy or see its location(s) in the image.</p>
                </div>

                <div class="setting-group" id="skin-tone-analysis-section">
                    <h4>Skin Tone Analysis [beta]</h4>
                    <p>Disclaimer: This tool is a work in progress. -- Pick a color from the image that best represents your skin tone to get color recommendations. For best results, choose an area on your jawline or inner arm in natural lighting.</p>
                    <button id="pick-skin-tone-button">Pick Skin Tone</button>
                    <p id="skin-tone-result"></p>

                    <div id="season-analysis-sub-section" style="margin-top: 20px; border-top: 1px dashed var(--settings-outline); padding-top: 15px;">
                        <h4>Seasonal Color Analysis</h4>
                        <p style="font-size: 13px; line-height: 1.4; margin-bottom: 10px;">Select your natural hair and eye color to determine your color season. The analysis uses the skin tone selected above.</p>
                        <label for="hair-color-select">Natural Hair Color:</label>
                        <select id="hair-color-select" style="width: 100%; margin-bottom: 10px;">
                            <option value="black">Black</option>
                            <option value="dark_brown" selected>Dark Brown</option>
                            <option value="light_brown">Light Brown</option>
                            <option value="blonde">Blonde</option>
                            <option value="red">Red/Auburn</option>
                            <option value="grey">Grey/White</option>
                        </select>
                        <label for="eye-color-select">Eye Color:</label>
                        <select id="eye-color-select" style="width: 100%; margin-bottom: 10px;">
                            <option value="dark_brown" selected>Dark Brown</option>
                            <option value="light_brown">Light Brown/Hazel</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="grey">Grey</option>
                            <option value="black">Black</option>
                        </select>
                        <div id="season-analysis-result" style="font-weight: normal; color: var(--skin-tone-result-text-color); font-size: 13px; line-height: 1.6; white-space: pre-wrap;"></div>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Palette Extraction Settings</h4>
                    <div class="slider-input-group">
                        <label for="num-colors">Number of Colors:</label>
                        <input type="range" id="num-colors" min="2" max="20" step="1" value="8">
                        <input type="number" id="num-colors-num" min="2" max="20" step="1" value="8" class="slider-value-input">
                    </div>
                    <div class="slider-input-group">
                        <label for="sample-size">Sample Density:</label>
                        <input type="range" id="sample-size" min="0.1" max="1" step="0.1" value="0.5">
                        <input type="number" id="sample-size-num" min="0.1" max="1" step="0.1" value="0.5" class="slider-value-input">
                    </div>
                    <div class="slider-input-group">
                        <label for="color-group-size">Skin Tone Sample Area:</label>
                        <input type="range" id="color-group-size" min="1" max="25" step="1" value="3">
                        <input type="number" id="color-group-size-num" min="1" max="25" step="1" value="3" class="slider-value-input">
                    </div>
                    <p style="font-size:12px; opacity:0.8;">Adjusting "Sample Density" too high on large images may cause performance issues. Sampling- frequency of colors are sampled from an image to determine the most dominant / representative colors.</p>
                    <br>
                    	<p>Note that this is a tool for general guidance not substitute of professional analysis. </p>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-panel" style="display: none;">
        <div class="settings-panel-header">
            <h3>General Settings</h3>
            <div class="header-buttons">
                <button id="apply-general-settings-button">Apply</button>
                <button id="reset-settings-button">Reset</button>
            </div>
        </div>
        <div class="setting-group">
            <h4>Colors</h4>
            <label>Background: <input type="color" id="bg-color" value="#f0f0f0"></label>
            <label>Frame: <input type="color" id="frame-color" value="#333333"></label>
            <label>Text: <input type="color" id="text-color" value="#333333"></label>
            <label>Button BG: <input type="color" id="button-bg" value="#e0e0e0"></label>
            <label>Button Text: <input type="color" id="button-text" value="#333333"></label>
            <label>Settings BG: <input type="color" id="settings-bg" value="#ffffff"></label>
            <label>Settings Outline: <input type="color" id="settings-outline" value="#cccccc"></label>
            <label>Slider Track: <input type="color" id="slider-track" value="#dddddd"></label>
            <label>Slider Thumb: <input type="color" id="slider-thumb" value="#666666"></label>
            <label>Checkbox: <input type="color" id="checkbox-color" value="#666666"></label>
            <label>Color Outline: <input type="color" id="color-outline-color" value="#0000ff"></label>
            <label>Table Header BG: <input type="color" id="table-header-bg" value="#f5f5f5"></label>
            <label>Table Row Odd BG: <input type="color" id="table-row-bg-odd" value="#ffffff"></label>
            <label>Table Row Even BG: <input type="color" id="table-row-bg-even" value="#f9f9f9"></label>
            <label>Table Border: <input type="color" id="table-border-color" value="#e0e0e0"></label>
            <label>Copy Hover BG: <input type="color" id="copy-btn-hover-bg" value="rgba(0,0,0,0.05)"></label>
            <label>Skin Tone Result Text: <input type="color" id="skin-tone-result-text-color" value="#000000"></label>
            <label>Delete Button BG: <input type="color" id="delete-button-bg" value="#ff4d4d"></label>
            <label>Delete Button Text: <input type="color" id="delete-button-text" value="#ffffff"></label>
            <label>Delete Button Hover BG: <input type="color" id="delete-button-hover-bg" value="#cc0000"></label>
            <label>Suggested Palette Outline: <input type="color" id="suggested-palette-outline" value="#888888"></label>
        </div>
        <div class="setting-group">
            <h4>Input Styles</h4>
            <label>Input BG Color: <input type="color" id="number-input-bg" value="#ffffff"></label>
            <label>Input Outline Color: <input type="color" id="number-input-outline-color" value="#cccccc"></label>
            <label>Input Outline Radius: <input type="number" id="number-input-outline-radius" min="0" max="50" value="30"></label>
        </div>
        <div class="setting-group">
            <h4>Border Radius</h4>
            <label>Frame: <input type="number" id="frame-radius" min="0" max="50" value="5"></label>
            <label>Buttons: <input type="number" id="button-radius" min="0" max="50" value="30"></label>
            <label>Settings UI: <input type="number" id="settings-radius" min="0" max="50" value="3"></label>
        </div>
        <div class="setting-group">
            <h4>Font</h4>
            <label>Font Family: <select id="font-family">
                <option value="'Monospace', monospace" selected>Monospace</option>
                <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Arial', sans-serif">Arial</option>
                <option value="'Georgia', serif">Georgia</option>
                <option value="'Impact', sans-serif">Impact</option>
            </select> </label>
            <label>Font Size: <input type="number" id="font-size" min="10" max="18" value="14"></label>
        </div>
        <div class="setting-group">
            <h4>Frame Size</h4>
            <label>Custom Size (px): <input type="number" id="frame-custom-size" min="200" max="1000" value="400"></label>
            <label>Min Size (px): <input type="number" id="frame-custom-min-size" min="200" max="500" value="300"></label>
            <label>In-frame UI Scale: <input type="range" id="in-frame-ui-scale" min="0.5" max="1.5" step="0.1" value="1"></label>
        </div>
    </div>

    <input type="file" id="image-input" accept="image/*" style="display: none;">

    <canvas id="hidden-canvas" style="display:none;"></canvas>
    
    <div id="magnifier" style="display: none;">
        <canvas id="magnifier-canvas"></canvas>
        <div id="magnifier-crosshair">+</div>
        <div id="magnifier-info">
            <div class="color-display"></div>
            <span class="hex-code"><span class="rgb-code"></span></span>
        </div>
    </div>
    <div id="copy-notification">Copied!</div>
    
    <footer style="text-align: center; margin-top: 20px; color: #555; padding: 10px;">
        <a href="https://xetsue.github.io/" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">xetsue.github.io</a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.querySelector('.main-container');
            const frame = document.querySelector('.frame');
            const imageDisplay = document.getElementById('image-display');
            const uploadedImage = document.getElementById('uploaded-image');
            const placeholderText = document.getElementById('placeholder-text');
            const settingsButton = document.getElementById('settings-button');
            const paletteSettingsButton = document.getElementById('palette-settings-button');
            const layoutButton = document.getElementById('layout-button');
            const uploadButton = document.getElementById('upload-button');
            const clearButton = document.getElementById('clear-button');
            const analyzeButton = document.getElementById('analyze-button');
            const exportButton = document.getElementById('export-button');
            const swapPanelsButton = document.getElementById('swap-panels-button');
            const applyGeneralSettingsBtn = document.getElementById('apply-general-settings-button');
            const resetSettingsBtn = document.getElementById('reset-settings-button');
            const fullscreenButton = document.getElementById('fullscreen-button');
            const hideUiButton = document.getElementById('hide-ui-button');
            const hideFrameUiButton = document.getElementById('hide-frame-ui-button');
            const settingsPanel = document.getElementById('settings-panel');
            const paletteAnalysisPanel = document.getElementById('palette-analysis-panel');
            const dragHandle = document.getElementById('drag-handle');
            const fullscreenBottomLeftControls = document.querySelector('.fullscreen-bottom-left-controls');
            const imageInput = document.getElementById('image-input');
            const hiddenCanvas = document.getElementById('hidden-canvas');
            const hiddenCtx = hiddenCanvas.getContext('2d', { willReadFrequently: true });
            const paletteTableBody = document.querySelector('#color-palette-table tbody');
            const numColorsInput = document.getElementById('num-colors');
            const numColorsNumInput = document.getElementById('num-colors-num');
            const sampleSizeInput = document.getElementById('sample-size');
            const sampleSizeNumInput = document.getElementById('sample-size-num');
            const pickSkinToneButton = document.getElementById('pick-skin-tone-button');
            const skinToneResult = document.getElementById('skin-tone-result');
            const controlsDiv = document.querySelector('.controls');
            const colorGroupSizeInput = document.getElementById('color-group-size');
            const colorGroupSizeNumInput = document.getElementById('color-group-size-num');

            const hairColorSelect = document.getElementById('hair-color-select');
            const eyeColorSelect = document.getElementById('eye-color-select');
            const seasonAnalysisResult = document.getElementById('season-analysis-result');

            const pickColorButton = document.getElementById('pick-color-button');
            const magnifier = document.getElementById('magnifier');
            const magnifierCanvas = document.getElementById('magnifier-canvas');
            const magnifierCtx = magnifierCanvas.getContext('2d', { willReadFrequently: true });
            const magnifierInfo = document.getElementById('magnifier-info');
            const magnifierColorDisplay = magnifierInfo.querySelector('.color-display');
            const magnifierHexCode = magnifierInfo.querySelector('.hex-code');
            const magnifierRgbCode = magnifierInfo.querySelector('.rgb-code');
            const copyNotification = document.getElementById('copy-notification');
            const eyedropperCrosshair = document.getElementById('eyedropper-crosshair'); 

            const generalSettingsInputs = document.querySelectorAll('#settings-panel input, #settings-panel select');
            const paletteSettingsInputs = document.querySelectorAll('#palette-analysis-panel input[type="range"], #palette-analysis-panel input[type="number"]');

            const themeToggleButton = document.getElementById('theme-toggle-button');

            let originalImage = null;
            let currentPalette = [];
            let isPalettePanelManuallyHidden = false;
            let isKeyboardOpen = false;
            let isManualLayoutEnabled = true;
            let dragState = { active: false, currentX: 0, currentY: 0, initialX: 0, initialY: 0, xOffset: 0, yOffset: 0 };
            let currentSkinToneAnalysisResult = "";
            let currentSeasonAnalysisResult = "";
            let currentSkinToneInfo = null;
            let isPickingColor = false;
            let isPickingSkinTone = false;
            let isDarkTheme = false;

            const defaultSettings = {
                'bg-color': '#f0f0f0',
                'frame-color': '#333333',
                'text-color': '#333333',
                'button-bg': '#e0e0e0',
                'button-text': '#333333',
                'settings-bg': '#ffffff',
                'settings-outline': '#cccccc',
                'slider-track': '#dddddd',
                'slider-thumb': '#666666',
                'checkbox-color': '#666666',
                'frame-radius': '5',
                'button-radius': '30',
                'settings-radius': '3',
                'font-family': "'Monospace', monospace",
                'font-size': '14',
                'in-frame-ui-scale': '1',
                'number-input-bg': '#ffffff',
                'number-input-outline-color': '#cccccc',
                'number-input-outline-radius': '30',
                'frame-custom-size': '400',
                'frame-custom-min-size': '300',
                'table-header-bg': '#f5f5f5',
                'table-row-bg-odd': '#ffffff',
                'table-row-bg-even': '#f9f9f9',
                'table-border-color': '#e0e0e0',
                'color-outline-color': '#0000ff',
                'copy-btn-hover-bg': 'rgba(0,0,0,0.05)',
                'skin-tone-result-text-color': '#000000',
                'delete-button-bg': '#ff4d4d',
                'delete-button-text': '#ffffff',
                'delete-button-hover-bg': '#cc0000',
                'suggested-palette-outline': '#888888',
                'hair-color-select': 'dark_brown',
                'eye-color-select': 'dark_brown'
            };

            const darkThemeSettings = {
                'bg-color': '#1a1a1a',
                'frame-color': '#888888',
                'text-color': '#e0e0e0',
                'button-bg': '#333333',
                'button-text': '#e0e0e0',
                'settings-bg': '#2a2a2a',
                'settings-outline': '#444444',
                'slider-track': '#555555',
                'slider-thumb': '#aaaaaa',
                'checkbox-color': '#aaaaaa',
                'table-header-bg': '#3a3a3a',
                'table-row-bg-odd': '#2a2a2a',
                'table-row-bg-even': '#303030',
                'table-border-color': '#444444',
                'color-outline-color': '#9999ff',
                'copy-btn-hover-bg': 'rgba(255,255,255,0.1)',
                'skin-tone-result-text-color': '#e0e0e0',
                'number-input-bg': '#3a3a3a',
                'number-input-outline-color': '#555555',
                'delete-button-bg': '#993333',
                'delete-button-hover-bg': '#cc0000',
                'suggested-palette-outline': '#666666'
            };
            
            // New reference colors for undertone analysis
            const undertoneReferenceColors = {
                'Warm': ['#F6D4B9', '#DEBA96', '#DAB08C', '#CD865A', '#B37858', '#96624D', '#552E1F', '#D39F66','#BD8E5A'],
                'Neutral': ['#D6AA8D','#F3D7C2', '#DCBA9E', '#CA9978', '#BC8F68', '#BB815C', '#A16F4C', '#60311F', '#A05C35', '#CF8361', '#EFA069', '#B45230', '#FACBA1', '#CD8B51', '#C38151'],
                'Cool': ['#F0CBB0', '#E4C9B6', '#DFBDA2', '#D6A98A', '#B77E53', '#653728', '#533624', '#DFAB9D', '#AE6B52', '#E0A18F', '#D38467', '#C15B4D', '#D37329', '#C3582C', '#BF784E', '#D5A88B', '#EAD5C2', '#DFA57D', '#E29060'],
		'Olive': ['#8A7559', '#B6996F', '#9C7E5A', '#C7AA7C', '#C8AD83', '#D8C3A8', '#F4C197', '#DDC898', '#B7874D', '#D6A667', '#D09A58', '#D9B591', '#BD8E5A', '#B29784', '#856C4D', '#B79780', '#B1907D', '#BA9C82', '#988066', '#AA8F72', '#A58AA7', '#A6836D', '#786951', '#7E6850', '#998561', '#C3A381', '#B9956C', '#877163', '#C0A57E', '#9B6D00', '#9F8D01', '#7F6400', '#C3B87C', '#C4A569', '#7C5300', '#E8DDBF', '#FDF2C1', '#B0A569', '#FFE8C0', '#B29F68', '#C4A569', '#CFB899', '#95775D', '#BB9878','#AE8B6D', '#B18E6E', '#C4A569', '#FFE8C0', '#C3B87C', '#B0A569', '#B29F68']    
            };
            let referenceLabColors = {}; // Will be populated later

            settingsButton.addEventListener('click', () => togglePanel(settingsPanel));
            paletteSettingsButton.addEventListener('click', () => togglePanel(paletteAnalysisPanel, true));
            layoutButton.addEventListener('click', toggleManualLayout);
            uploadButton.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleFileUpload);
            clearButton.addEventListener('click', () => location.reload()); 
            analyzeButton.addEventListener('click', () => {
                if (!originalImage || !originalImage.naturalWidth) {
                    alert("Please upload an image first.");
                    return;
                }
                extractColorPalette(originalImage);
                if (paletteAnalysisPanel.style.display === 'none') {
                    togglePanel(paletteAnalysisPanel, true);
                }
            });
            pickColorButton.addEventListener('click', () => toggleEyedropper(false));
            pickSkinToneButton.addEventListener('click', () => toggleEyedropper(true));
            exportButton.addEventListener('click', exportResults);
            applyGeneralSettingsBtn.addEventListener('click', applyGeneralSettings);
            resetSettingsBtn.addEventListener('click', resetSettingsToDefault);
            themeToggleButton.addEventListener('click', toggleTheme);
            
            swapPanelsButton.addEventListener('click', () => mainContainer.classList.toggle('swapped'));
            
            hideFrameUiButton.addEventListener('click', () => {
                frame.classList.toggle('ui-hidden');
                controlsDiv.classList.toggle('minimized');
            });

            fullscreenButton.addEventListener('click', toggleFullscreen);
            hideUiButton.addEventListener('click', () => frame.classList.toggle('ui-hidden'));

            paletteSettingsInputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (originalImage) extractColorPalette(originalImage);
                    saveSettings();
                });
            });

            hairColorSelect.addEventListener('change', () => {
                if (currentSkinToneInfo) analyzeSeason();
                saveSettings();
            });
            eyeColorSelect.addEventListener('change', () => {
                if (currentSkinToneInfo) analyzeSeason();
                saveSettings();
            });


            document.querySelectorAll('.slider-input-group').forEach(group => {
                const slider = group.querySelector('input[type="range"]');
                const number = group.querySelector('input[type="number"]');
                if (slider && number) {
                    slider.addEventListener('input', () => number.value = slider.value);
                    number.addEventListener('input', () => slider.value = number.value);
                }
            });

            window.addEventListener('resize', checkLayout);
            document.addEventListener('click', closePanelsOnClickOutside);

            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const newIsKeyboardOpen = window.visualViewport.height < window.innerHeight;
                    if (newIsKeyboardOpen !== isKeyboardOpen) {
                        isKeyboardOpen = newIsKeyboardOpen;
                    }
                });
            }

            dragHandle.addEventListener('mousedown', dragStart);
            dragHandle.addEventListener('touchstart', dragStart);

            imageDisplay.addEventListener('mousemove', handleEyedropperMove);
            imageDisplay.addEventListener('touchmove', handleEyedropperMove, { passive: false });
            imageDisplay.addEventListener('mouseup', handleEyedropperConfirmSelection);
            imageDisplay.addEventListener('touchend', handleEyedropperConfirmSelection);
            imageDisplay.addEventListener('mouseleave', hideMagnifier);
            imageDisplay.addEventListener('touchcancel', hideMagnifier);

            function preProcessReferenceColors() {
                for (const tone in undertoneReferenceColors) {
                    referenceLabColors[tone] = undertoneReferenceColors[tone].map(hex => {
                        const rgb = hexToRgb(hex.trim());
                        return rgbToLab(rgb[0], rgb[1], rgb[2]);
                    });
                }
            }
            
            preProcessReferenceColors();
            loadSettings();
            applyGeneralSettings();
            checkLayout();

            function toggleTheme() {
                const body = document.body;
                isDarkTheme = !isDarkTheme;
                body.classList.toggle('dark-theme', isDarkTheme);
                themeToggleButton.textContent = isDarkTheme ? 'Dark' : 'Light';

                const currentThemeSettings = isDarkTheme ? darkThemeSettings : defaultSettings;
                for (const key in currentThemeSettings) {
                    if (key.endsWith('-color') || key.endsWith('-bg')) {
                        const inputElement = document.getElementById(key);
                        if (inputElement && inputElement.type === 'color') {
                            inputElement.value = currentThemeSettings[key];
                        }
                    }
                }
                saveSettings();
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage.src = e.target.result;
                    uploadedImage.style.display = 'block';
                    placeholderText.style.display = 'none';
                    originalImage = uploadedImage;
                    
                    uploadedImage.onload = () => {
                        extractColorPalette(originalImage);
                        if (paletteAnalysisPanel.style.display === 'none') {
                            togglePanel(paletteAnalysisPanel, true);
                        }
                    };
                    uploadedImage.onerror = () => {
                        alert('Error: Could not load image.');
                        uploadedImage.src = '';
                        uploadedImage.style.display = 'none';
                        placeholderText.style.display = 'block';
                        originalImage = null;
                    };
                };
                reader.readAsDataURL(file);
            }

            function extractColorPalette(imgElement) {
                if (!imgElement || !imgElement.naturalWidth) {
                    paletteTableBody.innerHTML = '<tr><td colspan="3">No image loaded to extract palette.</td></tr>';
                    currentPalette = [];
                    return;
                }
                
                const numColors = parseInt(numColorsInput.value, 10);
                const sampleSize = parseFloat(sampleSizeInput.value);

                const ctx = hiddenCtx;
                const scaleFactor = Math.min(1, 1000 / Math.max(imgElement.naturalWidth, imgElement.naturalHeight));
                hiddenCanvas.width = imgElement.naturalWidth * scaleFactor;
                hiddenCanvas.height = imgElement.naturalHeight * scaleFactor;
                ctx.drawImage(imgElement, 0, 0, hiddenCanvas.width, hiddenCanvas.height);

                const imageData = ctx.getImageData(0, 0, hiddenCanvas.width, hiddenCanvas.height);
                const pixels = imageData.data;
                const pixelCount = hiddenCanvas.width * hiddenCanvas.height;

                const colors = [];
                const step = Math.max(1, Math.floor(1 / sampleSize));

                for (let i = 0; i < pixelCount; i += step) {
                    const idx = i * 4;
                    const r = pixels[idx];
                    const g = pixels[idx + 1];
                    const b = pixels[idx + 2];
                    if (typeof r === 'number' && typeof g === 'number' && typeof b === 'number') {
                        colors.push([r, g, b]);
                    }
                }

                if (colors.length === 0) {
                     paletteTableBody.innerHTML = '<tr><td colspan="3">No color data found in image.</td></tr>';
                     currentPalette = [];
                     return;
                }

                let centroids = [];
                if (colors.length > 0) {
                    centroids.push(colors[Math.floor(Math.random() * colors.length)]);
                    for (let k = 1; k < numColors; k++) {
                        let distances = [];
                        let totalDistance = 0;
                        for (const color of colors) {
                            let minDistToCentroids = Infinity;
                            for (const centroid of centroids) {
                                minDistToCentroids = Math.min(minDistToCentroids, colorDistance(color, centroid));
                            }
                            distances.push(minDistToCentroids * minDistToCentroids);
                            totalDistance += minDistToCentroids * minDistToCentroids;
                        }

                        let r = Math.random() * totalDistance;
                        let newCentroid = null;
                        for (let i = 0; i < colors.length; i++) {
                            r -= distances[i];
                            if (r <= 0) {
                                newCentroid = colors[i];
                                break;
                            }
                        }
                        if (newCentroid) {
                            centroids.push(newCentroid);
                        } else {
                            centroids.push(colors[Math.floor(Math.random() * colors.length)]);
                        }
                    }
                }

                const maxIterations = 20;
                for (let iter = 0; iter < maxIterations; iter++) {
                    const clusters = Array.from({ length: numColors }, () => []);
                    for (const color of colors) {
                        let minDist = Infinity;
                        let bestCentroidIdx = -1;
                        for (let i = 0; i < numColors; i++) {
                            const dist = colorDistance(color, centroids[i]);
                            if (dist < minDist) {
                                minDist = dist;
                                bestCentroidIdx = i;
                            }
                        }
                        if (bestCentroidIdx !== -1) {
                            clusters[bestCentroidIdx].push(color);
                        }
                    }

                    let newCentroids = [];
                    let changed = false;
                    for (let i = 0; i < numColors; i++) {
                        if (clusters[i].length > 0) {
                            const newCentroid = calculateMeanColor(clusters[i]);
                            if (colorDistance(newCentroid, centroids[i]) > 1) {
                                changed = true;
                            }
                            newCentroids.push(newCentroid);
                        } else {
                            newCentroids.push(colors[Math.floor(Math.random() * colors.length)]);
                            changed = true;
                        }
                    }
                    centroids = newCentroids;
                    if (!changed) break;
                }

                centroids.sort((a, b) => {
                    const brightnessA = (a[0] * 299 + a[1] * 587 + a[2] * 114) / 1000;
                    const brightnessB = (b[0] * 299 + b[1] * 587 + b[2] * 114) / 1000;
                    return brightnessB - brightnessA;
                });

                currentPalette = centroids.map(rgb => {
                    const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
                    const hsl = rgbToHsl(rgb[0], rgb[1], rgb[2]);
                    const cmyk = rgbToCmyk(rgb[0], rgb[1], rgb[2]);
                    return { rgb: rgb, hex: hex, hsl: hsl, cmyk: cmyk };
                });

                displayPalette(currentPalette);
            }

            function displayPalette(palette) {
                paletteTableBody.innerHTML = '';

                if (palette.length === 0) {
                    paletteTableBody.innerHTML = '<tr><td colspan="3">No palette extracted.</td></tr>';
                    return;
                }

                palette.forEach((color) => {
                    addPaletteRow(color);
                });
            }

            function addPaletteRow(color) {
                const row = paletteTableBody.insertRow();
                row.dataset.colorHex = color.hex;

                const colorSampleCell = row.insertCell();
                colorSampleCell.classList.add('color-sample-cell');
                const colorSampleDiv = document.createElement('div');
                colorSampleDiv.className = 'color-sample';
                colorSampleDiv.style.backgroundColor = `rgb(${color.rgb[0]},${color.rgb[1]},${color.rgb[2]})`;
                colorSampleCell.appendChild(colorSampleDiv);

                const hexCell = row.insertCell();
                hexCell.innerHTML = `<span class="color-value">${color.hex}</span>`;
                hexCell.querySelector('.color-value').addEventListener('click', (e) => {
                    copyTextToClipboard(color.hex);
                    showColorLocation(color.rgb);
                });

                const delCell = row.insertCell();
                const delButton = document.createElement('button');
                delButton.classList.add('delete-btn');
                delButton.textContent = 'DEL';
                delButton.addEventListener('click', () => deleteColorFromPalette(color.hex, row));
                delCell.appendChild(delButton);
            }

            function deleteColorFromPalette(hexToDelete, rowToRemove) {
                currentPalette = currentPalette.filter(color => color.hex !== hexToDelete);
                rowToRemove.remove();
            }

            function copyTextToClipboard(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showCopyNotification();
                    }).catch(() => {
                        fallbackCopyTextToClipboard(text);
                    });
                } else {
                    fallbackCopyTextToClipboard(text);
                }
            }

            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showCopyNotification();
                    } else {
                        alert('Copy failed: Your browser does not support automatic copying for local files. Please manually copy the text: ' + text);
                    }
                } catch (err) {
                    alert('Copy failed: Your browser does not support automatic copying for local files. Please manually copy the text: ' + text);
                }
                document.body.removeChild(textArea);
            }

            function showCopyNotification() {
                copyNotification.style.opacity = '1';
                clearTimeout(copyNotification._timeoutId);
                copyNotification._timeoutId = setTimeout(() => {
                    copyNotification.style.opacity = '0';
                }, 1500);
            }

            function showColorLocation(targetRgb) {
                if (!originalImage || !originalImage.naturalWidth) return;

                document.querySelectorAll('.color-location-indicator').forEach(el => el.remove());

                const imgNaturalWidth = originalImage.naturalWidth;
                const imgNaturalHeight = originalImage.naturalHeight;

                hiddenCanvas.width = imgNaturalWidth;
                hiddenCanvas.height = imgNaturalHeight;
                hiddenCtx.drawImage(originalImage, 0, 0, imgNaturalWidth, imgNaturalHeight);
                const imageData = hiddenCtx.getImageData(0, 0, imgNaturalWidth, imgNaturalHeight);
                const pixels = imageData.data;

                const tolerance = 20;
                const maxLocations = 5;
                const minDistanceBetweenIndicators = 50; 

                const matchingLocations = [];

                for (let i = 0; i < pixels.length; i += 4) {
                    const r = pixels[i];
                    const g = pixels[i + 1];
                    const b = pixels[i + 2];

                    const dist = colorDistance([r, g, b], targetRgb);

                    if (dist < tolerance) {
                        const x = (i / 4) % imgNaturalWidth;
                        const y = Math.floor((i / 4) / imgNaturalWidth);

                        let tooClose = false;
                        for (const existingLoc of matchingLocations) {
                            if (Math.sqrt(Math.pow(x - existingLoc.x, 2) + Math.pow(y - existingLoc.y, 2)) < minDistanceBetweenIndicators) {
                                tooClose = true;
                                break;
                            }
                        }

                        if (!tooClose) {
                            matchingLocations.push({ x, y });
                            if (matchingLocations.length >= maxLocations) break;
                        }
                    }
                }

                if (matchingLocations.length === 0 && pixels.length > 0) {
                    let closestDist = Infinity;
                    let closestLoc = null;
                    const sampleStep = Math.max(1, Math.floor(pixels.length / (4 * 5000)));
                    for (let i = 0; i < pixels.length; i += 4 * sampleStep) {
                        const r = pixels[i];
                        const g = pixels[i + 1];
                        const b = pixels[i + 2];
                        const dist = colorDistance([r, g, b], targetRgb);
                        if (dist < closestDist) {
                            closestDist = dist;
                            const x = (i / 4) % imgNaturalWidth;
                            const y = Math.floor((i / 4) / imgNaturalWidth);
                            closestLoc = { x, y };
                        }
                    }
                    if (closestLoc) {
                         matchingLocations.push(closestLoc);
                    }
                }

                const imgRect = uploadedImage.getBoundingClientRect();
                
                let actualImageDisplayWidth, actualImageDisplayHeight;
                let displayOffsetX, displayOffsetY;

                const aspectRatioNatural = imgNaturalWidth / imgNaturalHeight;
                const aspectRatioDisplay = imgRect.width / imgRect.height;

                if (aspectRatioDisplay > aspectRatioNatural) {
                    actualImageDisplayHeight = imgRect.height;
                    actualImageDisplayWidth = imgRect.height * aspectRatioNatural;
                    displayOffsetX = (imgRect.width - actualImageDisplayWidth) / 2;
                    displayOffsetY = 0;
                } else {
                    actualImageDisplayWidth = imgRect.width;
                    actualImageDisplayHeight = imgRect.width / aspectRatioNatural;
                    displayOffsetX = 0;
                    displayOffsetY = (imgRect.height - actualImageDisplayHeight) / 2;
                }

                const scaleX = actualImageDisplayWidth / imgNaturalWidth;
                const scaleY = actualImageDisplayHeight / imgNaturalHeight;

                matchingLocations.forEach(loc => {
                    const indicator = document.createElement('div');
                    indicator.classList.add('color-location-indicator');
                    indicator.textContent = '•';

                    const indicatorX = imgRect.left + displayOffsetX + (loc.x * scaleX);
                    const indicatorY = imgRect.top + displayOffsetY + (loc.y * scaleY);
                    
                    indicator.style.left = `${indicatorX}px`;
                    indicator.style.top = `${indicatorY}px`;
                    
                    document.body.appendChild(indicator); 
                });
            }
            
            function getDominantColors(colors, k) {
                if (!colors || colors.length === 0) return [];
                if (colors.length < k) {
                    return colors.map(c => [...c]);
                }

                let centroids = colors.slice(0, k).map(c => [...c]);

                for (let i = 0; i < 10; i++) {
                    const clusters = Array.from({ length: k }, () => []);
                    
                    for (const color of colors) {
                        let minDist = Infinity;
                        let bestCentroidIdx = 0;
                        for (let j = 0; j < k; j++) {
                            const dist = colorDistance(color, centroids[j]);
                            if (dist < minDist) {
                                minDist = dist;
                                bestCentroidIdx = j;
                            }
                        }
                        clusters[bestCentroidIdx].push(color);
                    }
                    
                    let newCentroids = [];
                    for (let j = 0; j < k; j++) {
                        if (clusters[j].length > 0) {
                            newCentroids.push(calculateMeanColor(clusters[j]));
                        } else {
                            newCentroids.push(colors[Math.floor(Math.random() * colors.length)]);
                        }
                    }
                    centroids = newCentroids;
                }
                return centroids;
            }

            function rgbToLab(r, g, b) {
                // Convert sRGB to XYZ
                let r1 = r / 255;
                let g1 = g / 255;
                let b1 = b / 255;

                r1 = r1 > 0.04045 ? Math.pow((r1 + 0.055) / 1.055, 2.4) : r1 / 12.92;
                g1 = g1 > 0.04045 ? Math.pow((g1 + 0.055) / 1.055, 2.4) : g1 / 12.92;
                b1 = b1 > 0.04045 ? Math.pow((b1 + 0.055) / 1.055, 2.4) : b1 / 12.92;

                r1 *= 100;
                g1 *= 100;
                b1 *= 100;

                const x = r1 * 0.4124 + g1 * 0.3576 + b1 * 0.1805;
                const y = r1 * 0.2126 + g1 * 0.7152 + b1 * 0.0722;
                const z = r1 * 0.0193 + g1 * 0.1192 + b1 * 0.9505;

                // Convert XYZ to Lab
                let x1 = x / 95.047;
                let y1 = y / 100.0;
                let z1 = z / 108.883;

                x1 = x1 > 0.008856 ? Math.pow(x1, 1/3) : (7.787 * x1) + (16 / 116);
                y1 = y1 > 0.008856 ? Math.pow(y1, 1/3) : (7.787 * y1) + (16 / 116);
                z1 = z1 > 0.008856 ? Math.pow(z1, 1/3) : (7.787 * z1) + (16 / 116);

                const L = (116 * y1) - 16;
                const a = 500 * (x1 - y1);
                const bLab = 200 * (y1 - z1);

                return { L: L, a: a, b: bLab };
            }
            
            // New helper function to get distance in Lab space
            function labColorDistance(lab1, lab2) {
                return Math.sqrt(
                    Math.pow(lab1.L - lab2.L, 2) +
                    Math.pow(lab1.a - lab2.a, 2) +
                    Math.pow(lab1.b - lab2.b, 2)
                );
            }

            function getSkinToneUndertone(rgbs) {
                if (rgbs.length === 0) {
                    return { undertone: 'Undetermined', confidence: 0, explanation: 'No color data provided for analysis.', palettes: [] };
                }

                const centerRgb = rgbs[0]; 
                const [r, g, b] = centerRgb;
                const hsl = rgbToHsl(r, g, b);
                const h = hsl.h;
                const s = hsl.s;
                const l = hsl.l;
                const lab = rgbToLab(r, g, b);

                let bestMatch = { undertone: 'Undetermined', confidence: 0, explanation: 'Could not confidently determine undertone.', palettes: [] };

                const undertoneProfiles = {
                    'Warm': {
                        hueRanges: [ { min: 25, max: 55 } ],
                        saturationRange: { min: 20, max: 70 },
                        lightnessRange: { min: 15, max: 90 },
                        labARange: { min: 10, max: 30 },
                        labBRange: { min: 20, max: 60 },
                        hueWeight: 0.3,
                        saturationWeight: 0.15,
                        lightnessWeight: 0.8,
                        labAWeight: 0.2,
                        labBWeight: 0.3,
                        description: "Your skin has golden, peachy, or yellow hues. You'll glow in rich, earthy tones like olive green, mustard, terracotta, warm reds, and deep browns.",
                        palettes: [
                            ['#8B4513', '#D2B48C', '#F4A460', '#BDB76B', '#A0522D'],
                            ['#FFD700', '#DAA520', '#B8860B', '#F0E68C', '#CD853F'],
                            ['#FF7F50', '#E9967A', '#F08080', '#CD5C5C', '#800000']
                        ]
                    },
                    'Cool': {
                        hueRanges: [ { min: 330, max: 360 }, { min: 0, max: 20 }, { min: 200, max: 280 } ],
                        saturationRange: { min: 15, max: 60 },
                        lightnessRange: { min: 15, max: 90 },
                        labARange: { min: -20, max: 10 },
                        labBRange: { min: -30, max: 20 },
                        hueWeight: 0.4,
                        saturationWeight: 0.2,
                        lightnessWeight: 0.1,
                        labAWeight: 0.4,
                        labBWeight: 0.5,
                        description: "Your skin has rosy, pinkish, or bluish hues. Jewel tones and cool shades like navy, emerald greens, cool reds (berry, wine), purples, and true blues will enhance your natural radiance.",
                        palettes: [
                            ['#4682B4', '#6A5ACD', '#483D8B', '#000080', '#191970'],
                            ['#20B2AA', '#40E0D0', '#48D1CC', '#00CED1', '#008B8B'],
                            ['#C71585', '#DDA0DD', '#BA55D3', '#9400D3', '#4B0082']
                        ]
                    },
                    'Neutral': {
                        hueRanges: [ { min: 15, max: 35 } ],
                        saturationRange: { min: 10, max: 45 },
                        lightnessRange: { min: 15, max: 90 },
                        labARange: { min: -5, max: 15 },
                        labBRange: { min: -5, max: 25 },
                        hueWeight: 0.3,
                        saturationWeight: 0.2,
                        lightnessWeight: 0.2,
                        labAWeight: 0.15,
                        labBWeight: 0.25,
                        description: "Your skin has a balanced mix of warm and cool tones, allowing you to wear a wide range of colors beautifully. Soft neutrals like greys, taupes, muted pastels, and medium shades often work best.",
                        palettes: [
                            ['#808080', '#A9A9A9', '#C0C0C0', '#D3D3D3', '#F5F5F5'],
                            ['#B8860B', '#D2B48C', '#E6BE8A', '#F0D1B0', '#F5E4D0'],
                            ['#B0C4DE', '#87CEEB', '#ADD8E6', '#B0E0E6', '#C6E2FF']
                        ]
                    },
                    'Olive': {
                        hueRanges: [ { min: 60, max: 120 } ],
                        saturationRange: { min: 10, max: 50 },
                        lightnessRange: { min: 20, max: 75 },
                        labARange: { min: -15, max: 5 },
                        labBRange: { min: 5, max: 30 },
                        isOliveCheck: (r, g, b, h_val, s_val) => {
                            const hasGreenishTint = g > r && g > b && (g > (r + b) / 2 + 10) && (Math.abs(r - b) < 40);
                            const isGreenishHue = (h_val >= 60 && h_val <= 120) && (s_val >= 10 && s_val <= 50);
                            const isDesaturated = s_val < 30;
                            return (hasGreenishTint || isGreenishHue) && isDesaturated;
                        },
                        hueWeight: 0.5,
                        saturationWeight: 0.2,
                        lightnessWeight: 0.1,
                        labAWeight: 0.1,
                        labBWeight: 0.2,
                        description: "Your skin has a greenish-grey or golden-green hue. You'll look great in earthy, muted, and jewel tones like moss green, deep teal, plum, maroon, and warm browns.",
                        palettes: [
                            ['#556B2F', '#6B8E23', '#808000', '#9ACD32', '#ADFF2F'],
                            ['#483C32', '#696969', '#708090', '#778899', '#B0C4DE'],
                            ['#8A2BE2', '#9370DB', '#8B008B', '#9932CC', '#6A5ACD']
                        ]
                    }
                };

                let scores = {};
                let oliveTendency = false;
                
                // === NEW LOGIC: Calculate scores based on distance to reference colors ===
                let referenceDistances = {};
                let totalMinDistance = 0;
                for (const tone in referenceLabColors) {
                    let minDistance = Infinity;
                    if(referenceLabColors[tone]) {
                        for (const refLab of referenceLabColors[tone]) {
                            const dist = labColorDistance(lab, refLab);
                            if (dist < minDistance) {
                                minDistance = dist;
                            }
                        }
                    }
                    referenceDistances[tone] = minDistance;
                    totalMinDistance += minDistance;
                }
                const referenceWeight = 0.8; // How much this new method influences the total score
                // =========================================================================

                for (const type in undertoneProfiles) {
                    const profile = undertoneProfiles[type];
                    let score = 0;

                    // --- Original Scoring (based on ranges) ---
                    let hueScore = 0;
                    for (const range of profile.hueRanges) {
                        if (range.min <= range.max) {
                            if (h >= range.min && h <= range.max) { hueScore = 1; break; }
                        } else {
                            if (h >= range.min || h <= range.max) { hueScore = 1; break; }
                        }
                    }
                    score += hueScore * profile.hueWeight;

                    if (s >= profile.saturationRange.min && s <= profile.saturationRange.max) score += 1 * profile.saturationWeight;
                    if (l >= profile.lightnessRange.min && l <= profile.lightnessRange.max) score += 1 * profile.lightnessWeight;
                    if (lab.a >= profile.labARange.min && lab.a <= profile.labARange.max) score += 1 * profile.labAWeight;
                    if (lab.b >= profile.labBRange.min && lab.b <= profile.labBRange.max) score += 1 * profile.labBWeight;
                    if (type === 'Olive' && profile.isOliveCheck(r, g, b, h, s)) score += 0.3;
                    
                    // --- NEW: Add reference color score ---
                    if (referenceDistances[type] !== undefined && totalMinDistance > 0) {
                        // Invert and normalize the distance to create a score (lower distance = higher score)
                        const refScoreContribution = (1 - (referenceDistances[type] / totalMinDistance)) * referenceWeight;
                        if (!isNaN(refScoreContribution)) {
                            score += refScoreContribution;
                        }
                    }
                    
                    scores[type] = score;
                }

                // Determine top undertones
                let sortedScores = Object.entries(scores).sort(([,a],[,b]) => b - a);
                let topUndertones = [];
                if (sortedScores.length > 0 && sortedScores[0][1] > 0) {
                    topUndertones.push(sortedScores[0][0]);
                    for(let i = 1; i < sortedScores.length; i++) {
                        if (sortedScores[i][1] >= sortedScores[0][1] * 0.7) {
                            topUndertones.push(sortedScores[i][0]);
                        } else {
                            break;
                        }
                    }
                }

                if (!topUndertones.includes('Olive') && undertoneProfiles['Olive'].isOliveCheck(r, g, b, h, s)) {
                    oliveTendency = true;
                }

                // Determine final undertone classification
                let finalUndertoneType = 'Undetermined';
                let finalExplanation = bestMatch.explanation;
                let suggestedPalettes = [];

                if (topUndertones.length > 0) {
                    if (topUndertones.includes('Olive')) {
                         if (topUndertones.includes('Cool')) {
                            finalUndertoneType = 'Cool Olive';
                            finalExplanation = "Your skin has a cool olive undertone, combining a greenish cast with pink/bluish hues. Deep jewel tones, cool muted greens, plums, and teals will flatter you.";
                            suggestedPalettes = undertoneProfiles['Olive'].palettes.concat(undertoneProfiles['Cool'].palettes);
                        } else if (topUndertones.includes('Warm')) {
                            finalUndertoneType = 'Warm Olive';
                            finalExplanation = "Your skin has a warm olive undertone, combining a greenish cast with golden/peachy hues. Earthy tones, warm muted greens, mustards, and coppers will look great.";
                            suggestedPalettes = undertoneProfiles['Olive'].palettes.concat(undertoneProfiles['Warm'].palettes);
                        } else if (topUndertones.includes('Neutral')) {
                            finalUndertoneType = 'Neutral Olive';
                            finalExplanation = "Your skin has a balanced neutral olive undertone, with a distinct greenish cast without strong warm or cool tendencies. Most muted and earthy tones will suit you well, especially moss greens and charcoal greys.";
                            suggestedPalettes = undertoneProfiles['Olive'].palettes.concat(undertoneProfiles['Neutral'].palettes);
                        } else {
                            finalUndertoneType = 'Olive';
                            finalExplanation = undertoneProfiles['Olive'].description;
                            suggestedPalettes = undertoneProfiles['Olive'].palettes;
                        }
                    } else {
                        if (oliveTendency) {
                            if (topUndertones.includes('Cool')) {
                                finalUndertoneType = 'Cool (with Olive tendency)';
                                finalExplanation = "Your skin is primarily cool but has a subtle olive (greenish) tendency. This gives you versatility with both cool colors and some muted earthy tones.";
                                suggestedPalettes = undertoneProfiles['Cool'].palettes.concat(undertoneProfiles['Olive'].palettes);
                            } else if (topUndertones.includes('Warm')) {
                                finalUndertoneType = 'Warm (with Olive tendency)';
                                finalExplanation = "Your skin is primarily warm but has a subtle olive (greenish) tendency. This means you can lean into warm earthy tones beautifully.";
                                suggestedPalettes = undertoneProfiles['Warm'].palettes.concat(undertoneProfiles['Olive'].palettes);
                            } else if (topUndertones.includes('Neutral')) {
                                finalUndertoneType = 'Neutral (with Olive tendency)';
                                finalExplanation = "Your skin is primarily neutral but has a subtle olive (greenish) tendency. This is a very versatile undertone, allowing you to wear a wide range of colors.";
                                suggestedPalettes = undertoneProfiles['Neutral'].palettes.concat(undertoneProfiles['Olive'].palettes);
                            } else {
                                finalUndertoneType = topUndertones.join(' & ');
                                finalExplanation = "Your skin shows characteristics of multiple undertones, including a subtle olive tendency.";
                                suggestedPalettes = [];
                            }
                        } else {
                            if (topUndertones.length === 1) {
                                finalUndertoneType = topUndertones[0];
                                finalExplanation = undertoneProfiles[topUndertones[0]].description;
                                suggestedPalettes = undertoneProfiles[topUndertones[0]].palettes;
                            } else {
                                finalUndertoneType = topUndertones.join(' & ');
                                finalExplanation = "Your skin tone shows characteristics of multiple undertones. Consider exploring colors that complement a blend of:\n";
                                suggestedPalettes = [];
                                topUndertones.forEach(ut => {
                                    finalExplanation += `\n• ${ut}:\n${undertoneProfiles[ut].description}\n`;
                                    if (undertoneProfiles[ut].palettes) {
                                        suggestedPalettes = suggestedPalettes.concat(undertoneProfiles[ut].palettes);
                                    }
                                });
                                finalExplanation += "\nExperimenting with muted or neutral versions of recommended colors can often yield the best results for mixed undertones.";
                            }
                        }
                    }

                    bestMatch.undertone = finalUndertoneType;
                    bestMatch.confidence = (sortedScores[0][1] / 2.0) * 100; // Normalize to 100% scale (adjusted max possible score)
                    if (isNaN(bestMatch.confidence)) bestMatch.confidence = 0;
                    bestMatch.explanation = finalExplanation;
                    bestMatch.palettes = suggestedPalettes;

                } else {
                    bestMatch.undertone = 'Undetermined';
                    bestMatch.confidence = 0;
                    bestMatch.explanation = "We couldn't confidently determine your undertone. This can happen with very dark or very light skin tones, or if the chosen color isn't representative. Try picking another spot, perhaps on your jawline or inner arm in natural lighting.";
                    bestMatch.palettes = [];
                }

                return bestMatch;
            }

            function analyzeSkinTone(selectedRgbGroup, centerRgb) {
                if (!selectedRgbGroup || selectedRgbGroup.length === 0) {
                    skinToneResult.innerHTML = "Please pick your skin color from the image first.";
                    currentSkinToneAnalysisResult = "";
                    currentSkinToneInfo = null;
                    analyzeSeason();
                    return;
                }
                
                const dominantSampleColors = getDominantColors(selectedRgbGroup, 3);
                dominantSampleColors.sort((a, b) => {
                    const brightnessA = (a[0] * 299 + a[1] * 587 + a[2] * 114) / 1000;
                    const brightnessB = (b[0] * 299 + b[1] * 587 + b[2] * 114) / 1000;
                    return brightnessA - brightnessB;
                });

                let sampledColorsHTML = '<div style="display: flex; gap: 4px; margin-bottom: 8px; margin-top: 5px;">';
                dominantSampleColors.forEach(rgb => {
                    const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
                    sampledColorsHTML += `<div class="palette-color-swatch" title="${hex}" data-hex="${hex}" style="width:25px; height:25px; background-color: ${hex}; cursor:default;"></div>`;
                });
                sampledColorsHTML += '</div>';

                const skinToneInfo = getSkinToneUndertone(selectedRgbGroup, centerRgb);
                const [r, g, b] = centerRgb;
                const skinHSL = rgbToHsl(r, g, b);
                
                currentSkinToneInfo = { ...skinToneInfo, hsl: skinHSL, rgb: centerRgb };

                let suggestedContrast = '';
                if (skinHSL.l > 70) {
                    suggestedContrast = '\nFor lighter skin tones, opting for darker, richer colors will create a beautiful contrast and make your features pop.';
                } else if (skinHSL.l < 30) {
                    suggestedContrast = 'On darker skin tones, vibrant and lighter colors often stand out beautifully, while deep tones can add a sense of rich elegance.';
                } else {
                    suggestedContrast = '\nMedium skin tones are versatile. Consider experimenting with both lighter and darker shades to find the most dynamic contrasts that enhance your natural glow.';
                }
                
                currentSkinToneAnalysisResult = `Selected Color: [ ${rgbToHex(r,g,b)} ]\n\n`;
                currentSkinToneAnalysisResult += `Likely Undertone:${skinToneInfo.undertone} (Fidelity: ${skinToneInfo.confidence.toFixed(1)}%)\n\n`;
                currentSkinToneAnalysisResult += `Color Theory Insights:\n`;
                currentSkinToneAnalysisResult += `${skinToneInfo.explanation}\n`;
                currentSkinToneAnalysisResult += `${suggestedContrast}`;
                
                let displayHTML = `<strong>Selected Color: ${rgbToHex(r, g, b)} (RGB: ${r}, ${g}, ${b})</strong>` +
                    sampledColorsHTML +
                    `<strong>Likely Undertone:</strong>${skinToneInfo.undertone} [Fidelity: ${skinToneInfo.confidence.toFixed(1)}%]<br><br>` +
                    `<strong>Color Theory Insights:</strong>${skinToneInfo.explanation}<br>${suggestedContrast}`;
                
                skinToneResult.innerHTML = displayHTML.replace(/\n/g, '<br>');

                displaySuggestedPalettes(skinToneInfo.palettes);
                
                analyzeSeason();
            }

            function displaySuggestedPalettes(palettes, container = skinToneResult, title = 'Suggested Color Palettes:') {
                let palettesHtml = '';
                if (palettes && palettes.length > 0) {
                    palettesHtml += `<div class="suggested-palettes"><h5>${title}</h5>`;
                    palettes.forEach((palette) => {
                        palettesHtml += `<div class="color-palette-row">`;
                        palette.forEach(hex => {
                            palettesHtml += `<div class="palette-color-swatch" style="background-color: ${hex};" data-hex="${hex}"></div>`;
                        });
                        palettesHtml += `</div>`;
                    });
                    palettesHtml += '</div>';
                }
                
                const existingPalettesDiv = container.querySelector('.suggested-palettes');
                if (existingPalettesDiv) {
                    existingPalettesDiv.remove();
                }

                if (palettesHtml) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = palettesHtml;
                    container.appendChild(tempDiv.firstChild);

                    container.querySelectorAll('.palette-color-swatch').forEach(swatch => {
                        swatch.addEventListener('click', (e) => {
                            copyTextToClipboard(e.target.dataset.hex);
                        });
                    });
                }
            }
            
            function analyzeSeason() {
                if (!currentSkinToneInfo) {
                    seasonAnalysisResult.innerHTML = "Pick a skin tone above to begin.";
                    currentSeasonAnalysisResult = "";
                    return;
                }

                const hair = hairColorSelect.value;
                const eye = eyeColorSelect.value;
                const undertone = currentSkinToneInfo.undertone.toLowerCase();
                const skinL = currentSkinToneInfo.hsl.l;
                const skinS = currentSkinToneInfo.hsl.s;

                const hairValue = { black: 10, dark_brown: 8, light_brown: 5, red: 6, blonde: 3, grey: 4 }[hair];
                const eyeValue = { black: 10, dark_brown: 8, light_brown: 5, blue: 4, green: 5, grey: 6 }[eye];
                
                const overallContrast = Math.abs(hairValue - (skinL / 10));
                
                const isClear = skinS > 40 || 
                               (hair === 'black' || hair === 'red' || hair === 'blonde') || 
                               (eye === 'blue' || eye === 'green');

                let primarySeason = '';
                let subSeason = '';
                
                if (undertone.includes('cool')) {
                    if (overallContrast >= 5) {
                        primarySeason = 'Winter';
                        subSeason = isClear ? 'Bright Winter' : 'Deep Winter';
                    } else {
                        primarySeason = 'Summer';
                        subSeason = isClear ? 'Light Summer' : (skinL > 60 ? 'Soft Summer' : 'Cool Summer');
                    }
                } else if (undertone.includes('warm') || undertone.includes('olive')) {
                    if (overallContrast >= 4.5) {
                        primarySeason = 'Spring';
                        subSeason = isClear ? 'Bright Spring' : 'Warm Spring';
                    } else {
                        primarySeason = 'Autumn';
                        subSeason = isClear ? 'Soft Autumn' : (skinL > 50 ? 'Warm Autumn' : 'Deep Autumn');
                    }
                } else {
                    if (overallContrast >= 5) {
                        primarySeason = isClear ? 'Bright Spring' : 'Deep Winter';
                    } else if (overallContrast >= 4) {
                        primarySeason = isClear ? 'Light Spring' : 'Soft Autumn';
                    } else {
                        primarySeason = isClear ? 'Light Summer' : 'Soft Summer';
                    }
                    subSeason = primarySeason;
                }
                
                const seasonData = {
                    'Bright Winter': {
                        description: "Bright Winters have cool undertones with high contrast and clarity. Your best colors are icy brights and jewel tones like fuchsia, emerald green, royal blue, and pure white. Avoid muted or earthy tones.",
                        palettes: [
                            ['#FF00FF', '#00BFFF', '#DC143C', '#FFFFFF', '#000000'],
                            ['#4B0082', '#008080', '#FF1493', '#7FFFD4', '#9400D3']
                        ]
                    },
                    'Deep Winter': {
                        description: "Deep Winters have cool undertones with very high contrast between features. Your best colors are deep, rich cool tones like navy, plum, pine green, and ruby red. Avoid pastels and warm earth tones.",
                        palettes: [
                            ['#000080', '#8B0000', '#006400', '#4B0082', '#191970'],
                            ['#483D8B', '#800020', '#2F4F4F', '#8B008B', '#000000']
                        ]
                    },
                    'Cool Summer': {
                        description: "Cool Summers have soft cool undertones with medium contrast. Your best colors are soft, cool, and muted like powder blue, lavender, rose pink, and slate grey. Avoid bright or warm colors.",
                        palettes: [
                            ['#B0C4DE', '#DDA0DD', '#FFB6C1', '#778899', '#E6E6FA'],
                            ['#4682B4', '#9370DB', '#C71585', '#708090', '#87CEFA']
                        ]
                    },
                    'Light Summer': {
                        description: "Light Summers have cool undertones with low contrast and a delicate appearance. Your best colors are light, cool, and soft like pastel blue, mauve, seafoam green, and light grey. Avoid dark or intense colors.",
                        palettes: [
                            ['#ADD8E6', '#E6E6FA', '#98FB98', '#F0E68C', '#FFB6C1'],
                            ['#87CEEB', '#D8BFD8', '#AFEEEE', '#FFDAB9', '#DDA0DD']
                        ]
                    },
                    'Soft Summer': {
                        description: "Soft Summers have neutral-cool undertones with muted, low-contrast features. Your best colors are soft, cool, and greyed like dusty rose, sage green, lavender grey, and soft teal. Avoid bright or warm colors.",
                        palettes: [
                            ['#BC8F8F', '#C0C0C0', '#B0E0E6', '#D8BFD8', '#A9A9A9'],
                            ['#778899', '#9370DB', '#CD5C5C', '#8FBC8F', '#DDA0DD']
                        ]
                    },
                    'Bright Spring': {
                        description: "Bright Springs have warm undertones with high contrast and clarity. Your best colors are clear, warm, and vibrant like coral, turquoise, lime green, and golden yellow. Avoid muted or cool colors.",
                        palettes: [
                            ['#FF4500', '#00CED1', '#32CD32', '#FFD700', '#FF6347'],
                            ['#FF8C00', '#40E0D0', '#9ACD32', '#FFA500', '#00FA9A']
                        ]
                    },
                    'Warm Spring': {
                        description: "Warm Springs have golden warm undertones with medium-high contrast. Your best colors are warm and clear like peach, aqua, golden yellow, and camel. Avoid cool or muted colors.",
                        palettes: [
                            ['#FFA07A', '#87CEFA', '#F0E68C', '#D2B48C', '#FFDAB9'],
                            ['#FF7F50', '#00BFFF', '#FFD700', '#CD853F', '#FFE4B5']
                        ]
                    },
                    'Light Spring': {
                        description: "Light Springs have warm undertones with low contrast and a delicate appearance. Your best colors are light, warm, and clear like peach, butter yellow, aqua, and light camel. Avoid dark or cool colors.",
                        palettes: [
                            ['#FFDAB9', '#87CEFA', '#F0E68C', '#FFE4B5', '#FFA07A'],
                            ['#FFDEAD', '#AFEEEE', '#FAFAD2', '#FFE4C4', '#FFB6C1']
                        ]
                    },
                    'Warm Autumn': {
                        description: "Warm Autumns have golden warm undertones with medium contrast. Your best colors are rich, warm, and earthy like mustard, burnt orange, olive green, and camel. Avoid cool or bright colors.",
                        palettes: [
                            ['#D2691E', '#B8860B', '#556B2F', '#CD853F', '#8B4513'],
                            ['#A0522D', '#DAA520', '#6B8E23', '#BC8F8F', '#D2B48C']
                        ]
                    },
                    'Soft Autumn': {
                        description: "Soft Autumns have neutral-warm undertones with muted, low-contrast features. Your best colors are soft, warm, and earthy like mauve, moss green, peach, and soft camel. Avoid bright or cool colors.",
                        palettes: [
                            ['#BC8F8F', '#D2B48C', '#8FBC8F', '#CD853F', '#F5DEB3'],
                            ['#DEB887', '#DAA520', '#98FB98', '#E9967A', '#F0E68C']
                        ]
                    },
                    'Deep Autumn': {
                        description: "Deep Autumns have warm undertones with very high contrast between features. Your best colors are deep, rich, and warm like burgundy, forest green, burnt orange, and chocolate brown. Avoid pastels and cool colors.",
                        palettes: [
                            ['#800000', '#556B2F', '#8B4513', '#4A412A', '#A0522D'],
                            ['#8B0000', '#2E8B57', '#D2691E', '#483C32', '#8B008B']
                        ]
                    }
                };
                
                const result = seasonData[subSeason] || seasonData[primarySeason] || {
                    description: "Unable to determine sub-season. The general season is " + primarySeason,
                    palettes: []
                };
                
                let seasonHTML = `<strong>Likely Season:</strong>${primarySeason}`;
                if (subSeason && subSeason !== primarySeason) {
                    seasonHTML += ` (${subSeason})`;
                }
                seasonHTML += `\n\n${result.description}`;

                currentSeasonAnalysisResult = `--- Seasonal Analysis ---\n` + seasonHTML;

                seasonAnalysisResult.innerHTML = seasonHTML.replace(/\n/g, '<br>');
                displaySuggestedPalettes(result.palettes, seasonAnalysisResult, 'Seasonal Color Palettes:');
            }


            function exportResults() {
                let exportContent = `Color Palette Extraction Results\n`;
                exportContent += `Date: ${new Date().toLocaleString()}\n\n`;
                exportContent += `--- Extracted Color Palette ---\n`;
                if (currentPalette.length > 0) {
                    currentPalette.forEach((color, index) => {
                        exportContent += `Color ${index + 1}:\n`;
                        exportContent += `  Hex: ${color.hex}\n`;
                        exportContent += `  RGB: ${color.rgb[0]}, ${color.rgb[1]}, ${color.rgb[2]}\n\n`;
                    });
                } else {
                    exportContent += `No color palette extracted yet.\n\n`;
                }
                
                exportContent += "--- Skin Tone Analysis ---\n";
                exportContent += currentSkinToneAnalysisResult.replace(/<strong>(.*?)<\/strong>/g, '$1').replace(/<br>/g, '\n') + "\n\n";

                exportContent += currentSeasonAnalysisResult.replace(/<strong>(.*?)<\/strong>/g, '$1') + "\n\n";


                const blob = new Blob([exportContent], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'color_palette_results.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }

            function applyGeneralSettings() {
                const root = document.documentElement;
                generalSettingsInputs.forEach(input => {
                    const variableName = '--' + input.id;
                    let value = input.value;
                    if (input.type === 'number' && !input.id.includes('in-frame-ui-scale')) {
                        value += 'px';
                    }
                    root.style.setProperty(variableName, value);
                });
                saveSettings();
            }

            function resetSettingsToDefault() {
                const root = document.documentElement;
                for (const id in defaultSettings) {
                    const value = defaultSettings[id];
                    const input = document.getElementById(id);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = (value === 'true');
                        } else {
                            input.value = value;
                        }
                        let cssValue = value;
                        if (input.type === 'number' && !id.includes('in-frame-ui-scale')) {
                            cssValue += 'px';
                        }
                        root.style.setProperty('--' + id, cssValue);
                    }
                }
                saveSettings();
                if (isDarkTheme) {
                    toggleTheme();
                }
            }

            function saveSettings() {
                const settings = {};
                document.querySelectorAll('input, select').forEach(el => {
                    if (el.id) settings[el.id] = el.type === 'checkbox' ? el.checked : el.value;
                });
                settings.isDarkTheme = isDarkTheme;
                localStorage.setItem('colorPaletteExtractorSettings', JSON.stringify(settings));
            }

            function loadSettings() {
                const settings = JSON.parse(localStorage.getItem('colorPaletteExtractorSettings'));
                if (settings) {
                    document.querySelectorAll('input, select').forEach(el => {
                        if (el.id && settings[el.id] !== undefined) {
                            if (el.type === 'checkbox') el.checked = settings[el.id];
                            else el.value = settings[el.id];
                        }
                    });
                    isDarkTheme = settings.isDarkTheme || false;
                    document.body.classList.toggle('dark-theme', isDarkTheme);
                    themeToggleButton.textContent = isDarkTheme ? 'Dark' : 'Light';
                } else {
                     hairColorSelect.value = defaultSettings['hair-color-select'];
                     eyeColorSelect.value = defaultSettings['eye-color-select'];
                }

                isManualLayoutEnabled = true; 
                mainContainer.classList.add('side-by-side-layout');
                paletteAnalysisPanel.style.display = 'block';
                isPalettePanelManuallyHidden = false;
                updateLayoutButtonText();
            }

            function togglePanel(panelToToggle, forceShow = false) {
                if (panelToToggle === settingsPanel) {
                    if (settingsPanel.style.display === 'block' && !forceShow) {
                        settingsPanel.style.display = 'none';
                    } else {
                        settingsPanel.style.display = 'block';
                    }
                } else if (panelToToggle === paletteAnalysisPanel) {
                    if (mainContainer.classList.contains('side-by-side-layout')) {
                        if (forceShow) {
                            paletteAnalysisPanel.style.display = 'block';
                            isPalettePanelManuallyHidden = false;
                        } else {
                            if (paletteAnalysisPanel.style.display === 'block') {
                                paletteAnalysisPanel.style.display = 'none';
                                isPalettePanelManuallyHidden = true;
                            } else {
                                paletteAnalysisPanel.style.display = 'block';
                                isPalettePanelManuallyHidden = false;
                            }
                        }
                    } else {
                        if (paletteAnalysisPanel.style.display === 'block' && !forceShow) {
                            paletteAnalysisPanel.style.display = 'none';
                            isPalettePanelManuallyHidden = true;
                        } else {
                            paletteAnalysisPanel.style.display = 'block';
                            isPalettePanelManuallyHidden = false;
                        }
                    }
                }
            }


            function closePanelsOnClickOutside(event) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') || isKeyboardOpen) {
                    return;
                }

                if (settingsPanel.style.display === 'block' && !settingsPanel.contains(event.target) && event.target !== settingsButton) {
                    settingsPanel.style.display = 'none';
                }
                
                if (!mainContainer.classList.contains('side-by-side-layout') &&
                    paletteAnalysisPanel.style.display === 'block' &&
                    !paletteAnalysisPanel.contains(event.target) &&
                    event.target !== paletteSettingsButton &&
                    event.target !== analyzeButton &&
                    event.target !== pickColorButton &&
                    event.target !== pickSkinToneButton
                ) {
                    paletteAnalysisPanel.style.display = 'none';
                    isPalettePanelManuallyHidden = true;
                }
            }

            function toggleManualLayout() {
                isManualLayoutEnabled = !isManualLayoutEnabled;
                if (isManualLayoutEnabled) {
                    mainContainer.classList.add('side-by-side-layout');
                    paletteAnalysisPanel.style.display = 'block';
                    paletteAnalysisPanel.style.transform = 'translate3d(0, 0, 0)';
                    dragState.xOffset = 0;
                    dragState.yOffset = 0;
                    isPalettePanelManuallyHidden = false;
                } else {
                    mainContainer.classList.remove('side-by-side-layout');
                    if (paletteAnalysisPanel.style.display === 'block' && !isKeyboardOpen) {
                         paletteAnalysisPanel.style.display = 'none';
                         isPalettePanelManuallyHidden = true;
                    }
                    paletteAnalysisPanel.style.transform = 'none';
                    dragState.xOffset = 0;
                    dragState.yOffset = 0;
                }
                updateLayoutButtonText();
            }

            function updateLayoutButtonText() {
                layoutButton.textContent = isManualLayoutEnabled ? 'Layout: Side-by-Side' : 'Layout: Stacked';
            }

            function checkLayout() {
                if (isManualLayoutEnabled) {
                    mainContainer.classList.add('side-by-side-layout');
                    if (!isPalettePanelManuallyHidden) {
                        paletteAnalysisPanel.style.display = 'block';
                    }
                    updateLayoutButtonText();
                    return;
                }

                const shouldBeSideBySideBasedOnViewport = window.innerWidth >= 992 || (window.innerWidth >= 768 && window.matchMedia("(orientation: landscape)").matches);

                if (shouldBeSideBySideBasedOnViewport) {
                    mainContainer.classList.add('side-by-side-layout');
                    if (!isPalettePanelManuallyHidden) {
                        paletteAnalysisPanel.style.display = 'block';
                    }
                } else {
                    mainContainer.classList.remove('side-by-side-layout');
                    if (paletteAnalysisPanel.style.display === 'block' && !isKeyboardOpen) {
                         paletteAnalysisPanel.style.display = 'none';
                         isPalettePanelManuallyHidden = true;
                    }
                }
                if (!mainContainer.classList.contains('side-by-side-layout')) {
                    paletteAnalysisPanel.style.transform = 'none';
                    dragState.xOffset = 0;
                    dragState.yOffset = 0;
                }
                updateLayoutButtonText();
            }

            function toggleFullscreen() {
                const isFullscreen = frame.classList.toggle('fullscreen-active');
                
                if (isFullscreen) {
                    frame._originalParent = frame.parentNode;
                    frame._originalNextSibling = frame.nextSibling;
                    frame._originalPosition = frame.style.position || '';
                    frame._originalZIndex = frame.style.zIndex || '';
                    
                    document.body.appendChild(frame);
                    
                    frame.style.position = 'fixed';
                    frame.style.zIndex = '9999';
                    frame.style.top = '0';
                    frame.style.left = '0';
                    frame.style.width = '100vw';
                    frame.style.height = '100vh';
                    frame.style.margin = '0';
                    frame.style.padding = '0';
                    frame.style.border = 'none';
                    frame.style.resize = 'none';
                    
                    imageDisplay.style.width = '100%';
                    imageDisplay.style.height = '100%';
                    imageDisplay.style.overflow = 'hidden';
                } else {
                    if (frame._originalParent) {
                        if (frame._originalNextSibling) {
                            frame._originalParent.insertBefore(frame, frame._originalNextSibling);
                        } else {
                            frame._originalParent.appendChild(frame);
                        }
                    }
                    
                    frame.style.position = frame._originalPosition;
                    frame.style.zIndex = frame._originalZIndex;
                    frame.style.top = '';
                    frame.style.left = '';
                    frame.style.width = '';
                    frame.style.height = '';
                    frame.style.margin = '';
                    frame.style.padding = '';
                    frame.style.border = '';
                    frame.style.resize = '';
                    
                    imageDisplay.style.width = '';
                    imageDisplay.style.height = '';
                    imageDisplay.style.overflow = '';
                }
                
                fullscreenButton.textContent = isFullscreen ? 'Exit' : 'Full';
                fullscreenBottomLeftControls.style.display = isFullscreen ? 'flex' : 'none';
                settingsPanel.style.display = 'none';
                if (!mainContainer.classList.contains('side-by-side-layout')) {
                    paletteAnalysisPanel.style.display = 'none';
                    isPalettePanelManuallyHidden = true;
                }
                document.querySelectorAll('.color-location-indicator').forEach(el => el.remove());
                applyGeneralSettings();
            }
            
            function getTranslateXY(elm) {
                const style = window.getComputedStyle(elm);
                const matrix = new DOMMatrixReadOnly(style.transform);
                return { x: matrix.m41, y: matrix.m42 };
            }

            function dragStart(e) {
                if (!mainContainer.classList.contains('side-by-side-layout') || paletteAnalysisPanel.style.display === 'none') return;

                const currentTransform = getTranslateXY(paletteAnalysisPanel);
                dragState.xOffset = currentTransform.x;
                dragState.yOffset = currentTransform.y;

                dragState.initialX = e.type === 'touchstart' ? e.touches[0].clientX - dragState.xOffset : e.clientX - dragState.xOffset;
                dragState.initialY = e.type === 'touchstart' ? e.touches[0].clientY - dragState.yOffset : e.clientY - dragState.yOffset;

                if (e.target === dragHandle) {
                    dragState.active = true;
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'grabbing';
                    document.addEventListener('mouseup', dragEnd);
                    document.addEventListener('touchend', dragEnd);
                    document.addEventListener('mousemove', drag);
                    document.addEventListener('touchmove', drag);
                }
            }
            
            function dragEnd(e) {
                dragState.initialX = dragState.currentX;
                dragState.initialY = dragState.currentY;
                dragState.active = false;
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
                document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchend', dragEnd);
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('touchmove', drag);
            }
            
            function drag(e) {
                if (dragState.active) {
                    e.preventDefault();
                    let clientX, clientY;
                    if (e.type === 'touchmove') {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }
                    dragState.currentX = clientX - dragState.initialX;
                    dragState.currentY = clientY - dragState.initialY;

                    paletteAnalysisPanel.style.transform = `translate3d(${dragState.currentX}px, ${dragState.currentY}px, 0)`;
                }
            }

            function toggleEyedropper(forSkinTone) {
                if (!originalImage || !originalImage.naturalWidth) {
                    alert("Please upload an image first to use the color picker.");
                    return;
                }

                if (forSkinTone) {
                    isPickingSkinTone = !isPickingSkinTone;
                    isPickingColor = false;
                    pickColorButton.textContent = "Pick Color";
                } else {
                    isPickingColor = !isPickingColor;
                    isPickingSkinTone = false;
                    pickSkinToneButton.textContent = "Pick Skin Tone";
                }

                if (isPickingColor || isPickingSkinTone) {
                    if (isPickingColor) pickColorButton.textContent = "Exit Pick";
                    if (isPickingSkinTone) pickSkinToneButton.textContent = "Exit Pick";

                    frame.classList.add('eyedropper-active');
                    hiddenCanvas.width = originalImage.naturalWidth;
                    hiddenCanvas.height = originalImage.naturalHeight;
                    hiddenCtx.drawImage(originalImage, 0, 0);
                    magnifier.style.display = 'block';
                    eyedropperCrosshair.style.display = 'block'; 
                } else {
                    pickColorButton.textContent = "Pick Color";
                    pickSkinToneButton.textContent = "Pick Skin Tone";
                    frame.classList.remove('eyedropper-active');
                    magnifier.style.display = 'none';
                    eyedropperCrosshair.style.display = 'none'; 
                    hideMagnifier();
                    document.querySelectorAll('.color-location-indicator').forEach(el => el.remove());
                }
            }

            function handleEyedropperMove(e) {
                if (!(isPickingColor || isPickingSkinTone) || !originalImage || !originalImage.naturalWidth) return;

                e.preventDefault();

                let clientX, clientY;
                if (e.type.startsWith('touch')) {
                    if (e.touches.length === 0) return;
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                eyedropperCrosshair.style.left = `${clientX}px`;
                eyedropperCrosshair.style.top = `${clientY}px`;

                const imgRect = uploadedImage.getBoundingClientRect();
                
                let imgX = clientX - imgRect.left;
                let imgY = clientY - imgRect.top;

                const imgNaturalWidth = originalImage.naturalWidth;
                const imgNaturalHeight = originalImage.naturalHeight;
                const imgAspectRatio = imgNaturalWidth / imgNaturalHeight;
                const displayAspectRatio = imgRect.width / imgRect.height;

                let effectiveImgWidth, effectiveImgHeight;
                let offsetX = 0, offsetY = 0;

                if (displayAspectRatio > imgAspectRatio) {
                    effectiveImgHeight = imgRect.height;
                    effectiveImgWidth = imgRect.height * imgAspectRatio;
                    offsetX = (imgRect.width - effectiveImgWidth) / 2;
                } else {
                    effectiveImgWidth = imgRect.width;
                    effectiveImgHeight = imgRect.width / imgAspectRatio;
                    offsetY = (imgRect.height - effectiveImgHeight) / 2;
                }

                const scaledX = (imgX - offsetX) * (imgNaturalWidth / effectiveImgWidth);
                const scaledY = (imgY - offsetY) * (imgNaturalHeight / effectiveImgHeight);

                const pixelX = Math.max(0, Math.min(Math.floor(scaledX), imgNaturalWidth - 1));
                const pixelY = Math.max(0, Math.min(Math.floor(scaledY), imgNaturalHeight - 1));

                const pixelData = hiddenCtx.getImageData(pixelX, pixelY, 1, 1).data;
                const colorRgb = [pixelData[0], pixelData[1], pixelData[2]];
                const colorHex = rgbToHex(colorRgb[0], colorRgb[1], colorRgb[2]);

                magnifierColorDisplay.style.backgroundColor = `rgb(${colorRgb.join(',')})`;
                magnifierHexCode.textContent = colorHex;
                magnifierRgbCode.textContent = `RGB(${colorRgb.join(',')})`;
                magnifierInfo.style.backgroundColor = `rgba(${colorRgb.join(',')}, 0.85)`;
                magnifierInfo.style.color = getContrastTextColor(colorRgb[0], colorRgb[1], colorRgb[2]);


                const zoomFactor = 2;
                magnifierCanvas.width = magnifier.offsetWidth;
                magnifierCanvas.height = magnifier.offsetHeight - magnifierInfo.offsetHeight;

                magnifierCtx.imageSmoothingEnabled = false;
                magnifierCtx.clearRect(0, 0, magnifierCanvas.width, magnifierCanvas.height);

                const sourceSize = magnifierCanvas.width / zoomFactor;
                const drawX = pixelX - sourceSize / 2;
                const drawY = pixelY - sourceSize / 2;

                magnifierCtx.drawImage(
                    hiddenCanvas,
                    drawX, drawY, sourceSize, sourceSize,
                    0, 0, magnifierCanvas.width, magnifierCanvas.height
                );

                magnifier.style.left = `${clientX}px`;
                magnifier.style.top = `${clientY}px`;
                magnifier.style.display = 'block';
            }

            function handleEyedropperConfirmSelection(e) {
                if (!(isPickingColor || isPickingSkinTone) || !originalImage) return;

                if (e.type === 'mouseup' && e.button !== 0) return;

                const imgRect = uploadedImage.getBoundingClientRect();
                
                let clientX, clientY;
                if (e.type.startsWith('touch')) {
                    if (e.changedTouches.length === 0) return;
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                let imgX = clientX - imgRect.left;
                let imgY = clientY - imgRect.top;

                const imgNaturalWidth = originalImage.naturalWidth;
                const imgNaturalHeight = originalImage.naturalHeight;
                const imgAspectRatio = imgNaturalWidth / imgNaturalHeight;
                const displayAspectRatio = imgRect.width / imgRect.height;

                let effectiveImgWidth, effectiveImgHeight;
                let offsetX = 0, offsetY = 0;

                if (displayAspectRatio > imgAspectRatio) {
                    effectiveImgHeight = imgRect.height;
                    effectiveImgWidth = imgRect.height * imgAspectRatio;
                    offsetX = (imgRect.width - effectiveImgWidth) / 2;
                } else {
                    effectiveImgWidth = imgRect.width;
                    effectiveImgHeight = imgRect.width / imgAspectRatio;
                    offsetY = (imgRect.height - effectiveImgHeight) / 2;
                }

                const scaledX = (imgX - offsetX) * (imgNaturalWidth / effectiveImgWidth);
                const scaledY = (imgY - offsetY) * (imgNaturalHeight / effectiveImgHeight);

                const pixelX = Math.max(0, Math.min(Math.floor(scaledX), imgNaturalWidth - 1));
                const pixelY = Math.max(0, Math.min(Math.floor(scaledY), imgNaturalHeight - 1));
                
                const groupSize = parseInt(colorGroupSizeInput.value, 10);
                const halfGroup = Math.floor(groupSize / 2);

                const pixelsInGroup = [];
                let centerRgb = [0,0,0];

                for (let y = -halfGroup; y <= halfGroup; y++) {
                    for (let x = -halfGroup; x <= halfGroup; x++) {
                        const currentX = pixelX + x;
                        const currentY = pixelY + y;

                        if (currentX >= 0 && currentX < imgNaturalWidth && currentY >= 0 && currentY < imgNaturalHeight) {
                            const pixelData = hiddenCtx.getImageData(currentX, currentY, 1, 1).data;
                            const rgb = [pixelData[0], pixelData[1], pixelData[2]];
                            pixelsInGroup.push(rgb);
                            if (x === 0 && y === 0) {
                                centerRgb = rgb;
                            }
                        }
                    }
                }

                const dominantRgb = calculateMeanColor(pixelsInGroup);
                const dominantHex = rgbToHex(dominantRgb[0], dominantRgb[1], dominantRgb[2]);

                const pickedColor = {
                    rgb: dominantRgb,
                    hex: dominantHex,
                    hsl: rgbToHsl(dominantRgb[0], dominantRgb[1], dominantRgb[2]),
                    cmyk: rgbToCmyk(dominantRgb[0], dominantRgb[1], dominantRgb[2])
                };

                if (isPickingColor) {
                    const isDuplicate = currentPalette.some(color => color.hex === pickedColor.hex);
                    if (!isDuplicate) {
                        currentPalette.push(pickedColor);
                        currentPalette.sort((a, b) => {
                            const brightnessA = (a.rgb[0] * 299 + a.rgb[1] * 587 + a.rgb[2] * 114) / 1000;
                            const brightnessB = (b.rgb[0] * 299 + b.rgb[1] * 587 + b.rgb[2] * 114) / 1000;
                            return brightnessB - brightnessA;
                        });
                        displayPalette(currentPalette);
                    }
                }
                
                if (isPickingSkinTone) {
                    analyzeSkinTone(pixelsInGroup, centerRgb);
                }

                toggleEyedropper(false);
            }

            function hideMagnifier() {
                magnifier.style.display = 'none';
                eyedropperCrosshair.style.display = 'none'; 
                magnifierHexCode.textContent = '';
                magnifierRgbCode.textContent = '';
                magnifierColorDisplay.style.backgroundColor = '';
            }
            
            function rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
            }
            
            // New helper function to convert Hex to RGB
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? [
                    parseInt(result[1], 16),
                    parseInt(result[2], 16),
                    parseInt(result[3], 16)
                ] : null;
            }

            function rgbToHsl(r, g, b) {
                r /= 255;
                g /= 255;
                b /= 255;

                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r:
                            h = (g - b) / d + (g < b ? 6 : 0);
                            break;
                        case g:
                            h = (b - r) / d + 2;
                            break;
                        case b:
                            h = (r - g) / d + 4;
                            break;
                    }
                    h /= 6;
                }

                return {
                    h: h * 360,
                    s: s * 100,
                    l: l * 100
                };
            }

            function rgbToCmyk(r, g, b) {
                let c = 1 - (r / 255);
                let m = 1 - (g / 255);
                let y = 1 - (b / 255);
                let k = Math.min(c, Math.min(m, y));

                c = (c - k) / (1 - k);
                m = (m - k) / (1 - k);
                y = (y - k) / (1 - k);

                if (1 - k === 0) {
                    c = 0; m = 0; y = 0;
                } else if (isNaN(c) || isNaN(m) || isNaN(y)) {
                    c = 0; m = 0; y = 0; k = 1;
                }

                return {
                    c: c * 100,
                    m: m * 100,
                    y: y * 100,
                    k: k * 100
                };
            }

            function colorDistance(rgb1, rgb2) {
                return Math.sqrt(
                    Math.pow(rgb1[0] - rgb2[0], 2) +
                    Math.pow(rgb1[1] - rgb2[1], 2) +
                    Math.pow(rgb1[2] - rgb2[2], 2)
                );
            }

            function calculateMeanColor(colorsArray) {
                if (colorsArray.length === 0) return [0, 0, 0];
                let rSum = 0, gSum = 0, bSum = 0;
                for (const color of colorsArray) {
                    rSum += color[0];
                    gSum += color[1];
                    bSum += color[2];
                }
                return [
                    Math.round(rSum / colorsArray.length),
                    Math.round(gSum / colorsArray.length),
                    Math.round(bSum / colorsArray.length)
                ];
            }

            function getLuminance(r, g, b) {
                const a = [r, g, b].map(function (v) {
                    v /= 255;
                    return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
                });
                return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
            }
            
            function getContrastTextColor(r, g, b) {
                const luminance = getLuminance(r, g, b);
                return luminance > 0.5 ? 'black' : 'white';
            }
        });
    </script>
</body>
</html>
